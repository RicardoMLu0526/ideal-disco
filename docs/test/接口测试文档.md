# 微服务电商系统接口测试文档

## 文档信息

| 项目 | 内容 |
|:---|:---|
| 测试对象 | 微服务电商系统接口 |
| 系统版本 | v1.0 |
| 文档版本 | v1.0 |
| 创建日期 | 2026-02-26 |

---

# 第一部分：用户服务接口测试

## 1.1 获取用户信息

### 接口说明

根据用户ID获取用户详细信息，用于订单服务获取下单用户的基本信息。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 获取用户信息 |
| 接口路径 | GET /api/users/{userId} |
| 请求方法 | GET |
| 调用方 | 订单服务、前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌，格式：Bearer {token} |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| userId | Long | 是 | 用户ID |

### 请求示例

```
GET /api/users/1001 HTTP/1.1
Host: localhost:8081
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1001,
    "username": "user001",
    "phone": "13800138000",
    "email": "user@example.com",
    "nickname": "用户昵称",
    "avatar": "https://example.com/avatar.jpg",
    "status": 1
  },
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1001,
    "username": "user001",
    "phone": "13800138000",
    "email": "user@example.com",
    "nickname": "测试用户",
    "avatar": "https://example.com/avatar.jpg",
    "status": 1
  },
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 用户不存在 | {"code": 404, "message": "用户不存在", "data": null, "timestamp": 1708867200000} |
| 参数错误 | {"code": 400, "message": "用户ID格式错误", "data": null, "timestamp": 1708867200000} |
| 未授权 | {"code": 401, "message": "未授权访问", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| USER-API-001 | 正常获取用户信息 | 1. 传入有效的userId=1001<br>2. 携带有效Token | 返回code=200，data包含userId=1001的用户信息 | P0 |
| USER-API-002 | 用户不存在 | 1. 传入不存在的userId=999999<br>2. 携带有效Token | 返回code=404，message="用户不存在" | P0 |
| USER-API-003 | userId格式错误 | 1. 传入非数字userId=abc<br>2. 携带有效Token | 返回code=400，message="用户ID格式错误" | P0 |
| USER-API-004 | 未携带Token | 1. 不携带Authorization请求头 | 返回code=401，message="未授权访问" | P0 |
| USER-API-005 | Token无效 | 1. 携带无效Token<br>2. 传入有效userId | 返回code=401，message="Token无效" | P0 |
| USER-API-006 | userId为空 | 1. 不传入userId参数 | 返回code=404，message路径不匹配 | P0 |

---

## 1.2 获取用户收货地址列表

### 接口说明

获取指定用户的所有收货地址，返回地址列表。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 获取用户收货地址列表 |
| 接口路径 | GET /api/users/{userId}/addresses |
| 请求方法 | GET |
| 调用方 | 订单服务、前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌，格式：Bearer {token} |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| userId | Long | 是 | 用户ID |

### 请求示例

```
GET /api/users/1001/addresses HTTP/1.1
Host: localhost:8081
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "addressId": 1,
      "userId": 1001,
      "receiverName": "张三",
      "receiverPhone": "13800138000",
      "province": "广东省",
      "city": "深圳市",
      "district": "南山区",
      "detailAddress": "科技园路1号",
      "isDefault": 1
    }
  ],
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "addressId": 1,
      "userId": 1001,
      "receiverName": "张三",
      "receiverPhone": "13800138000",
      "province": "广东省",
      "city": "深圳市",
      "district": "南山区",
      "detailAddress": "科技园路1号",
      "isDefault": 1
    },
    {
      "addressId": 2,
      "userId": 1001,
      "receiverName": "李四",
      "receiverPhone": "13900139000",
      "province": "广东省",
      "city": "广州市",
      "district": "天河区",
      "detailAddress": "天河路100号",
      "isDefault": 0
    }
  ],
  "timestamp": 1708867200000
}
```

### 空列表响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [],
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 用户不存在 | {"code": 404, "message": "用户不存在", "data": null, "timestamp": 1708867200000} |
| 未授权 | {"code": 401, "message": "未授权访问", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| USER-API-101 | 正常获取地址列表 | 1. 传入有效的userId=1001<br>2. 携带有效Token | 返回code=200，data为AddressDTO列表 | P0 |
| USER-API-102 | 用户无地址 | 1. 传入有效userId但无地址<br>2. 携带有效Token | 返回code=200，data为空数组[] | P0 |
| USER-API-103 | 用户不存在 | 1. 传入不存在的userId=999999<br>2. 携带有效Token | 返回code=404，message="用户不存在" | P0 |
| USER-API-104 | 未携带Token | 1. 不携带Authorization请求头 | 返回code=401，message="未授权访问" | P0 |
| USER-API-105 | 地址列表包含默认地址 | 1. 用户有多个地址，其中一个为默认<br>2. 携带有效Token | 返回code=200，isDefault=1的地址在列表中 | P1 |

---

## 1.3 获取单个收货地址

### 接口说明

根据地址ID获取单个收货地址的详细信息。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 获取单个收货地址 |
| 接口路径 | GET /api/users/addresses/{addressId} |
| 请求方法 | GET |
| 调用方 | 订单服务、前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌，格式：Bearer {token} |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| addressId | Long | 是 | 地址ID |

### 请求示例

```
GET /api/users/addresses/1 HTTP/1.1
Host: localhost:8081
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "addressId": 1,
    "userId": 1001,
    "receiverName": "张三",
    "receiverPhone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detailAddress": "科技园路1号",
    "isDefault": 1
  },
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "addressId": 1,
    "userId": 1001,
    "receiverName": "张三",
    "receiverPhone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detailAddress": "科技园路1号",
    "isDefault": 1
  },
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 地址不存在 | {"code": 404, "message": "地址不存在", "data": null, "timestamp": 1708867200000} |
| 未授权 | {"code": 401, "message": "未授权访问", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| USER-API-201 | 正常获取地址详情 | 1. 传入有效的addressId=1<br>2. 携带有效Token | 返回code=200，data为AddressDTO对象 | P0 |
| USER-API-202 | 地址不存在 | 1. 传入不存在的addressId=999999<br>2. 携带有效Token | 返回code=404，message="地址不存在" | P1 |
| USER-API-203 | 未携带Token | 1. 不携带Authorization请求头 | 返回code=401，message="未授权访问" | P0 |

---

# 第二部分：商品服务接口测试

## 2.1 获取商品详情

### 接口说明

根据商品ID获取商品的详细信息。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 获取商品详情 |
| 接口路径 | GET /api/products/{productId} |
| 请求方法 | GET |
| 调用方 | 订单服务、前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌，格式：Bearer {token} |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| productId | Long | 是 | 商品ID |

### 请求示例

```
GET /api/products/1001 HTTP/1.1
Host: localhost:8082
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "productId": 1001,
    "name": "iPhone 15 Pro",
    "description": "最新款iPhone",
    "price": 8999.00,
    "originalPrice": 9999.00,
    "stock": 100,
    "sales": 50,
    "mainImage": "https://example.com/product.jpg",
    "status": 1
  },
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "productId": 1001,
    "name": "iPhone 15 Pro",
    "description": "最新款iPhone",
    "price": 8999.00,
    "originalPrice": 9999.00,
    "stock": 100,
    "sales": 50,
    "mainImage": "https://example.com/product.jpg",
    "status": 1
  },
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 商品不存在 | {"code": 404, "message": "商品不存在", "data": null, "timestamp": 1708867200000} |
| 商品已下架 | {"code": 200, "data": {"status": 0, ...}, ...}（返回下架商品信息） |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PROD-API-001 | 正常获取商品详情 | 1. 传入有效的productId=1001<br>2. 携带有效Token | 返回code=200，data为ProductDTO对象 | P0 |
| PROD-API-002 | 商品不存在 | 1. 传入不存在的productId=999999<br>2. 携带有效Token | 返回code=404，message="商品不存在" | P0 |
| PROD-API-003 | productId格式错误 | 1. 传入非数字productId=abc<br>2. 携带有效Token | 返回code=400，message="商品ID格式错误" | P0 |
| PROD-API-004 | 商品已下架 | 1. 传入已下架商品的productId<br>2. 携带有效Token | 返回code=200，data中status=0 | P1 |
| PROD-API-005 | 未携带Token | 1. 不携带Authorization请求头 | 返回code=401，message="未授权访问" | P0 |

---

## 2.2 查询商品库存

### 接口说明

查询商品的实时库存数量，返回整数类型。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 查询商品库存 |
| 接口路径 | GET /api/products/{productId}/stock |
| 请求方法 | GET |
| 调用方 | 订单服务、前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| productId | Long | 是 | 商品ID |

### 请求示例

```
GET /api/products/1001/stock HTTP/1.1
Host: localhost:8082
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "",
  "data": 100,
message": "success  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": 100,
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 商品不存在 | {"code": 404, "message": "商品不存在", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PROD-API-101 | 正常查询库存 | 1. 传入有效的productId=1001<br>2. 携带有效Token | 返回code=200，data为库存数量（Integer） | P0 |
| PROD-API-102 | 库存为零 | 1. 传入库存为0的商品productId<br>2. 携带有效Token | 返回code=200，data=0 | P0 |
| PROD-API-103 | 商品不存在 | 1. 传入不存在的productId<br>2. 携带有效Token | 返回code=404 | P0 |
| PROD-API-104 | 未携带Token | 1. 不携带Authorization请求头 | 返回code=401 | P0 |

---

## 2.3 预扣库存

### 接口说明

创建订单时预扣库存，防止超卖。虽然请求DTO与确认扣减相同，但通过不同路径区分。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 预扣库存 |
| 接口路径 | POST /api/products/stock/pre-deduct |
| 请求方法 | POST |
| 调用方 | 订单服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| productId | Long | 是 | 商品ID |
| quantity | Integer | 是 | 预扣数量，大于0 |
| orderNo | String | 是 | 订单编号，格式：ORD+17位数字 |

### 请求示例

```json
POST /api/products/stock/pre-deduct HTTP/1.1
Host: localhost:8082
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "productId": 1001,
  "quantity": 2,
  "orderNo": "ORD202602250001"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "预扣库存成功",
  "data": null,
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "预扣库存成功",
  "data": null,
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 库存不足 | {"code": 500, "message": "库存不足，当前库存：1，需要：2", "data": null, "timestamp": 1708867200000} |
| 数量无效 | {"code": 400, "message": "数量必须大于0", "data": null, "timestamp": 1708867200000} |
| 订单号格式错误 | {"code": 400, "message": "订单号格式错误", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PROD-API-201 | 正常预扣库存 | 1. 传入productId=1001, quantity=2, orderNo=ORD202602250001<br>2. 库存充足 | 返回code=200，message="预扣库存成功" | P0 |
| PROD-API-202 | 库存不足 | 1. 传入productId, quantity超过库存<br>2. 库存为1，quantity=2 | 返回code=500，message包含"库存不足" | P0 |
| PROD-API-203 | 库存为零 | 1. 传入productId, quantity=1<br>2. 库存为0 | 返回code=500，message包含"库存不足" | P0 |
| PROD-API-204 | 数量为零 | 1. quantity=0 | 返回code=400，message="数量必须大于0" | P0 |
| PROD-API-205 | 数量为负数 | 1. quantity=-1 | 返回code=400，message="数量必须大于0" | P0 |
| PROD-API-206 | 订单号格式错误 | 1. orderNo="123456"（不符合ORD+17位数字） | 返回code=400，message="订单号格式错误" | P0 |
| PROD-API-207 | 重复预扣同一订单 | 1. 同一订单号再次预扣 | 返回code=500，message="该订单已预扣" | P1 |
| PROD-API-208 | 未携带Token | 1. 不携带Authorization请求头 | 返回code=401 | P0 |

---

## 2.4 确认扣减库存

### 接口说明

支付成功后确认扣减库存，与预扣库存使用相同DTO，通过路径区分。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 确认扣减库存 |
| 接口路径 | POST /api/products/stock/deduct |
| 请求方法 | POST |
| 调用方 | 订单服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| productId | Long | 是 | 商品ID |
| quantity | Integer | 是 | 扣减数量，大于0 |
| orderNo | String | 是 | 订单编号 |

### 请求示例

```json
POST /api/products/stock/deduct HTTP/1.1
Host: localhost:8082
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "productId": 1001,
  "quantity": 2,
  "orderNo": "ORD202602250001"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "确认扣减成功",
  "data": null,
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "确认扣减成功",
  "data": null,
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 预扣记录不存在 | {"code": 404, "message": "预扣记录不存在", "data": null, "timestamp": 1708867200000} |
| 库存不足 | {"code": 500, "message": "库存不足", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PROD-API-301 | 正常确认扣减 | 1. 先预扣库存<br>2. 调用确认扣减接口 | 返回code=200，message="确认扣减成功" | P0 |
| PROD-API-302 | 无预扣记录 | 1. 未预扣直接确认扣减 | 返回code=404，message="预扣记录不存在" | P1 |
| PROD-API-303 | 库存不足 | 1. 预扣数量大于实际库存 | 返回code=500，message="库存不足" | P0 |

---

## 2.5 释放库存

### 接口说明

订单取消或支付失败时释放预扣库存。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 释放库存 |
| 接口路径 | POST /api/products/stock/release |
| 请求方法 | POST |
| 调用方 | 订单服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| productId | Long | 是 | 商品ID |
| quantity | Integer | 是 | 释放数量 |
| orderNo | String | 是 | 订单编号 |

### 请求示例

```json
POST /api/products/stock/release HTTP/1.1
Host: localhost:8082
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "productId": 1001,
  "quantity": 2,
  "orderNo": "ORD202602250001"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "释放库存成功",
  "data": null,
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "释放库存成功",
  "data": null,
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PROD-API-401 | 正常释放库存 | 1. 先预扣库存<br>2. 调用释放库存接口 | 返回code=200，message="释放库存成功" | P0 |
| PROD-API-402 | 无预扣记录 | 1. 未预扣直接释放 | 返回code=404，message="预扣记录不存在" | P1 |
| PROD-API-403 | 释放数量大于预扣 | 1. 释放数量大于实际预扣数量 | 返回code=500 | P1 |

---

## 2.6 批量获取商品信息

### 接口说明

根据商品ID列表批量获取商品信息。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 批量获取商品信息 |
| 接口路径 | POST /api/products/batch/info |
| 请求方法 | POST |
| 调用方 | 订单服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| productIds | List<Long> | 是 | 商品ID列表，最多100个 |

### 请求示例

```json
POST /api/products/batch/info HTTP/1.1
Host: localhost:8082
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

[1001, 1002, 1003]
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "productId": 1001,
      "name": "iPhone 15 Pro",
      "price": 8999.00,
      "stock": 100
    }
  ],
  "timestamp": 1708867200000}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "productId": 1001,
      "name": "iPhone 15 Pro",
      "price": 8999.00,
      "stock": 100
    },
    {
      "productId": 1002,
      "name": "iPhone 15",
      "price": 6999.00,
      "stock": 50
    }
  ],
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PROD-API-501 | 正常批量获取 | 1. 传入商品ID列表[1001,1002,1003] | 返回code=200，data为商品列表 | P1 |
| PROD-API-502 | 空列表 | 1. 传入空列表[] | 返回code=200，data为空数组 | P1 |
| PROD-API-503 | 超过100个ID | 1. 传入超过100个商品ID | 返回code=400，message="商品ID数量超出限制" | P1 |
| PROD-API-504 | 包含不存在ID | 1. 传入列表包含不存在的商品ID | 返回code=200，不存在的商品不出现在结果中 | P1 |

---

# 第三部分：订单服务接口测试

## 3.1 创建订单

### 接口说明

创建新订单，预扣库存，创建支付记录。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 创建订单 |
| 接口路径 | POST /api/orders |
| 请求方法 | POST |
| 调用方 | 前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| userId | Long | 是 | 用户ID |
| addressId | Long | 是 | 收货地址ID |
| items | List | 是 | 订单项列表，1-50项 |
| items[].productId | Long | 是 | 商品ID |
| items[].quantity | Integer | 是 | 购买数量，1-99 |
| remark | String | 否 | 订单备注 |

### 请求示例

```json
POST /api/orders HTTP/1.1
Host: localhost:8083
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "userId": 1001,
  "addressId": 1,
  "items": [
    {
      "productId": 1001,
      "quantity": 2
    },
    {
      "productId": 1002,
      "quantity": 1
    }
  ],
  "remark": "备注信息"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderNo": "ORD202602250001",
    "totalAmount": 17998.00,
    "payAmount": 17998.00,
    "status": 0,
    "paymentNo": "PAY202602250001"
  },
  "timestamp": 1708867200000
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderNo": "ORD202602250001",
    "totalAmount": 17998.00,
    "payAmount": 17998.00,
    "status": 0,
    "paymentNo": "PAY202602250001"
  },
  "timestamp": 1708867200000
}
```

### 失败响应示例

| 场景 | 响应 |
|:---|:---|
| 订单项为空 | {"code": 400, "message": "订单项不能为空", "data": null, "timestamp": 1708867200000} |
| 库存不足 | {"code": 500, "message": "库存不足", "data": null, "timestamp": 1708867200000} |
| 数量超限 | {"code": 400, "message": "单个商品最多购买99件", "data": null, "timestamp": 1708867200000} |

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| ORDER-API-001 | 正常创建订单 | 1. 传入userId、addressId、items、remark | 返回code=200，data包含orderNo、paymentNo | P0 |
| ORDER-API-002 | 订单项为空 | 1. items为空数组[] | 返回code=400，message="订单项不能为空" | P0 |
| ORDER-API-003 | 库存不足 | 1. 传入的商品库存不足 | 返回code=500，message="库存不足" | P0 |
| ORDER-API-004 | 数量超限 | 1. items[].quantity=100 | 返回code=400，message="单个商品最多购买99件" | P0 |
| ORDER-API-005 | 无收货地址 | 1. addressId不存在 | 返回code=404，message="地址不存在" | P0 |
| ORDER-API-006 | 用户不存在 | 1. userId不存在 | 返回code=404，message="用户不存在" | P0 |
| ORDER-API-007 | 未携带Token | 1. 不携带Authorization | 返回code=401 | P0 |

---

## 3.2 获取订单详情

### 接口说明

根据订单编号获取订单详细信息。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 获取订单详情 |
| 接口路径 | GET /api/orders/{orderNo} |
| 请求方法 | GET |
| 调用方 | 支付服务、前端 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| orderNo | String | 是 | 订单编号 |

### 请求示例

```
GET /api/orders/ORD202602250001 HTTP/1.1
Host: localhost:8083
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderNo": "ORD202602250001",
    "userId": 1001,
    "totalAmount": 17998.00,
    "payAmount": 17998.00,
    "status": 0,
    "paymentStatus": 0,
    "receiverName": "张三",
    "receiverPhone": "13800138000",
    "receiverAddress": "广东省深圳市南山区科技园路1号",
    "createTime": "2026-02-25T10:00:00",
    "payTime": null,
    "items": [...]
  },
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| ORDER-API-101 | 正常获取订单详情 | 1. 传入有效的orderNo | 返回code=200，data为OrderDTO | P0 |
| ORDER-API-102 | 订单不存在 | 1. 传入不存在的orderNo | 返回code=404，message="订单不存在" | P0 |
| ORDER-API-103 | 订单号格式错误 | 1. 传入格式错误的orderNo | 返回code=400 | P0 |

---

## 3.3 更新订单状态

### 接口说明

支付成功后更新订单状态。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 更新订单状态 |
| 接口路径 | PUT /api/orders/{orderNo}/status |
| 请求方法 | PUT |
| 调用方 | 支付服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| orderNo | String | 是 | 订单编号 |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| status | Integer | 是 | 订单状态，0-7 |
| paymentId | Long | 是 | 支付ID |
| payTime | LocalDateTime | 是 | 支付时间 |

### 请求示例

```json
PUT /api/orders/ORD202602250001/status HTTP/1.1
Host: localhost:8083
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "status": 1,
  "paymentId": 1001,
  "payTime": "2026-02-25T10:30:00"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": null,
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| ORDER-API-201 | 正常更新订单状态 | 1. 传入orderNo、status=1、paymentId、payTime | 返回code=200，data为null | P0 |
| ORDER-API-202 | 订单不存在 | 1. 传入不存在的orderNo | 返回code=404 | P0 |
| ORDER-API-203 | 状态值无效 | 1. status=8（超出0-7范围） | 返回code=400 | P0 |

---

## 3.4 支付成功回调

### 接口说明

支付成功后通知订单服务更新状态并确认扣减库存。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 支付成功回调 |
| 接口路径 | POST /api/orders/{orderNo}/paid |
| 请求方法 | POST |
| 调用方 | 支付服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Content-Type | String | 是 | application/json |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| orderNo | String | 是 | 订单编号 |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| paymentNo | String | 是 | 支付流水号 |
| amount | BigDecimal | 是 | 支付金额 |
| payTime | LocalDateTime | 是 | 支付时间 |
| paymentMethod | Integer | 是 | 支付方式，1-微信，2-支付宝 |

### 请求示例

```json
POST /api/orders/ORD202602250001/paid HTTP/1.1
Host: localhost:8083
Content-Type: application/json

{
  "paymentNo": "PAY202602250001",
  "amount": 17998.00,
  "payTime": "2026-02-25T10:30:00",
  "paymentMethod": 1
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": null,
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| ORDER-API-301 | 正常支付成功回调 | 1. 传入orderNo及支付信息 | 返回code=200，订单状态变为"已支付"，库存确认扣减 | P0 |
| ORDER-API-302 | 订单不存在 | 1. 传入不存在的orderNo | 返回code=404 | P0 |
| ORDER-API-303 | 订单已支付 | 1. 重复回调 | 返回code=200（幂等处理） | P1 |

---

## 3.5 支付失败回调

### 接口说明

支付失败后通知订单服务取消订单并释放库存。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 支付失败回调 |
| 接口路径 | POST /api/orders/{orderNo}/payment-failed |
| 请求方法 | POST |
| 调用方 | 支付服务 |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| paymentNo | String | 是 | 支付流水号 |
| failReason | String | 是 | 失败原因 |
| failTime | LocalDateTime | 是 | 失败时间 |

### 请求示例

```json
POST /api/orders/ORD202602250001/payment-failed HTTP/1.1
Host: localhost:8083
Content-Type: application/json

{
  "paymentNo": "PAY202602250001",
  "failReason": "用户取消支付",
  "failTime": "2026-02-25T10:30:00"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": null,
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| ORDER-API-401 | 正常支付失败回调 | 1. 传入orderNo及失败信息 | 返回code=200，订单状态变为"已取消"，释放库存 | P0 |
| ORDER-API-402 | 订单不存在 | 1. 传入不存在的orderNo | 返回code=404 | P0 |
| ORDER-API-403 | 订单已取消 | 1. 重复回调 | 返回code=200（幂等处理） | P1 |

---

# 第四部分：支付服务接口测试

## 4.1 创建支付

### 接口说明

创建支付记录，生成支付流水号。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 创建支付 |
| 接口路径 | POST /api/payments |
| 请求方法 | POST |
| 调用方 | 订单服务 |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| Authorization | String | 是 | 认证令牌 |
| Content-Type | String | 是 | application/json |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| orderNo | String | 是 | 订单编号 |
| userId | Long | 是 | 用户ID |
| amount | BigDecimal | 是 | 支付金额 |
| paymentMethod | Integer | 是 | 支付方式，1-微信，2-支付宝 |

### 请求示例

```json
POST /api/payments HTTP/1.1
Host: localhost:8084
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "orderNo": "ORD202602250001",
  "userId": 1001,
  "amount": 17998.00,
  "paymentMethod": 1
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "paymentNo": "PAY202602250001",
    "orderNo": "ORD202602250001",
    "amount": 17998.00,
    "paymentMethod": 1,
    "status": 0
  },
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PAY-API-001 | 正常创建支付 | 1. 传入orderNo、userId、amount、paymentMethod | 返回code=200，data包含paymentNo | P0 |
| PAY-API-002 | 订单不存在 | 1. orderNo不存在 | 返回code=404 | P0 |
| PAY-API-003 | 金额无效 | 1. amount<=0 | 返回code=400 | P0 |
| PAY-API-004 | 支付方式无效 | 1. paymentMethod=3 | 返回code=400 | P0 |

---

## 4.2 查询支付状态

### 接口说明

根据支付流水号查询支付状态。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 查询支付状态 |
| 接口路径 | GET /api/payments/{paymentNo} |
| 请求方法 | GET |
| 调用方 | 订单服务、前端 |

### Path参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| paymentNo | String | 是 | 支付流水号 |

### 请求示例

```
GET /api/payments/PAY202602250001 HTTP/1.1
Host: localhost:8084
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "paymentNo": "PAY202602250001",
    "orderNo": "ORD202602250001",
    "amount": 17998.00,
    "paymentMethod": 1,
    "status": 1,
    "payTime": "2026-02-25T10:30:00"
  },
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PAY-API-101 | 正常查询支付状态 | 1. 传入有效的paymentNo | 返回code=200，data为PaymentDTO | P0 |
| PAY-API-102 | 支付记录不存在 | 1. 传入不存在的paymentNo | 返回code=404 | P0 |

---

## 4.3 申请退款

### 接口说明

申请退款，退款金额不能超过实际支付金额。

### 请求信息

| 项目 | 内容 |
|:---|:---|
| 接口名称 | 申请退款 |
| 接口路径 | POST /api/payments/refund |
| 请求方法 | POST |
| 调用方 | 订单服务 |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| paymentNo | String | 是 | 支付流水号 |
| amount | BigDecimal | 是 | 退款金额 |
| reason | String | 是 | 退款原因 |

### 请求示例

```json
POST /api/payments/refund HTTP/1.1
Host: localhost:8084
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMDAxIn0.xxxx
Content-Type: application/json

{
  "paymentNo": "PAY202602250001",
  "amount": 17998.00,
  "reason": "商品质量问题"
}
```

### 返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "refundNo": "REFUND202602250001",
    "paymentNo": "PAY202602250001",
    "amount": 17998.00,
    "status": 0
  },
  "timestamp": 1708867200000
}
```

### 接口测试用例

| 用例ID | 用例描述 | 测试步骤 | 预期结果 | 优先级 |
|:---|:---|:---|:---|:---|
| PAY-API-201 | 正常申请退款 | 1. 传入paymentNo、amount、reason | 返回code=200，data包含refundNo | P1 |
| PAY-API-202 | 未支付订单 | 1. 支付状态非"已支付" | 返回code=400，message="该订单未支付，无法退款" | P1 |
| PAY-API-203 | 退款金额超限 | 1. amount大于实际支付金额 | 返回code=400，message="退款金额超出实际支付金额" | P1 |

---

# 附录：通用响应码说明

| 响应码 | 说明 |
|:---|:---|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
